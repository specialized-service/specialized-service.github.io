WRMCB=function(e){var c=console;if(c&&c.log&&c.error){c.log('Error running batched script.');c.error(e);}};try{define("cp/component/permalink/file-router",["jquery","backbone","confluence/jsUri","cp/component/versions/versions-navigation-plugin","cp/service/files-service"],function(e,k,d,l,c){var g=window.encodeURIComponent;var a=window.decodeURIComponent;var j=AJS.DarkFeatures.isEnabled("previews.sharing.pushstate")&&history.pushState;var f=function(m){return m.path()+m.query()+(m.anchor()?"#"+m.anchor():"")};var i=function(r,s){if(!r){return b()}var w=r.get("ownerId");var q;if(r.isLatestVersion&&!r.isLatestVersion()){q=r.getLatestVersion().get("id")}else{q=r.get("id")}var v=r.get("version");var u=s&&s.get("id");var n=r.get("src");var o=r.get("name");var m;if(!s){m=w?(w+"/"+q):g(n)}else{m=w+"/"+q+"/"+v+"/"+u}var x=o?("/"+g(o)):"";if(j){var t="/"+m+x;var p=new d(window.location.href);p=p.replaceQueryParam("preview",t);return f(p)}else{return"#!/preview/"+m+x}};var b=function(){if(j){var m=new d(window.location.href).deleteQueryParam("preview");return f(m)}else{return""}};var h=k.Router.extend({routes:{"!/preview/:ownerId/:id(/:name)":"handleViewer","!/preview/:ownerId/:id/:version/:commentId(/:replyId)(/:name)":"handleLinkForPin","!/preview/*src":"handleWebLink","":"handleCloseViewer","*path":"handleUrl"},initialize:function(m){if(k.History.started){return}this._enabled=true;this._mediaViewer=m.mediaViewer;this.on("route:handleViewer",function(o,p){this.selectFileById(o,p)});this.on("route:handleLinkForPin",function(p,v,q,s,o){var u=this;var r=this._mediaViewer.getCurrentFile();var t=function(w,x){var y=w.get("annotations");if(y){u._mediaViewer._fileState.trigger("cp.showAnnotations");if(x){u.listenToOnce(y,x,function(){y.selectCommentWithId(s,o)})}else{y.selectCommentWithId(s,o)}}};if(this._mediaViewer.isOpen()&&r&&r.get("ownerId")===p&&r.get("id")===v&&r.get("version")==q){t(r)}else{this.selectFileById(p,v,q).done(function(w){t(w,"sync")})}});this.on("route:handleWebLink",function(o){this.disableListeners();if(!this._mediaViewer.isOpen()){this._mediaViewer.open()}this._mediaViewer.showFileWithSrc(o);this.enableListeners()});var n=function(){if(!j){return}var o=new d(window.location.href);if(o.getQueryParamValue("preview")){e(window).off("popstate",n);if(!this._mediaViewer||!this._mediaViewer.getCurrentFile()){k.history.loadUrl("!/preview"+a(o.getQueryParamValue("preview")))}}else{if(m.mediaViewer.isOpen()){m.mediaViewer.close()}e(window).off("popstate",n);e(window).on("popstate",n)}}.bind(this);this.on("route:handleUrl",n);this.on("route:handleCloseViewer",function(){this._mediaViewer.close()});this.enableListeners()},start:function(){if(!k.History.started){k.history.start({pushState:j})}},setEnabled:function(m){this._enabled=m},selectFileById:function(m,p,n){this.disableListeners();if(!this._mediaViewer.isOpen()){this._mediaViewer.open()}function o(r){this._mediaViewer._fileState.setCurrentWithCID(r.cid);var q;if(!n||n==r.get("version")){q=this._mediaViewer.showFile(r)}else{q=l.showFileForPreviousVersion(this._mediaViewer,r,n)}this.enableListeners();return q}return this._selectFileById(m,p,n).then(o.bind(this)).fail(function(){this._mediaViewer._fileState.setNoCurrent()}.bind(this))},_selectFileById:function(n,s,o){var r=e.Deferred();var q=this.getCollection();var p=q.findWhere({id:s,ownerId:n});if(p){r.resolve(p)}else{var m=new c(n);m.getFilesWithId([s]).then(function(t){q.add(t);var u=q.findWhere({id:s,ownerId:n});if(u){r.resolve(u)}else{r.reject()}})}return r},getCollection:function(){return this._mediaViewer._fileState.collection},enableListeners:function(){this.listenTo(this._mediaViewer,"fv.changeFile fv.close",this._setRoute);this.listenTo(this._mediaViewer.getView().fileSidebarView,"initializePanel",this._setRouteOnSidebarOpen);this.listenTo(this._mediaViewer.getView().fileSidebarView,"teardownPanel",this._setRouteOnSidebarClose)},disableListeners:function(){this.stopListening(this._mediaViewer,"fv.changeFile fv.close",this._setRoute);this.stopListening(this._mediaViewer.getView().fileSidebarView,"initializePanel",this._setRouteOnSidebarOpen);this.stopListening(this._mediaViewer.getView().fileSidebarView,"teardownPanel",this._setRouteOnSidebarClose)},_setRoute:function(p,m,o){if(this._enabled){var n=i(p,m);this.navigate(n,{trigger:!n||(j&&!new d(n).getQueryParamValue("preview")),replace:!!m||o||(p&&p.isLatestVersion&&!p.isLatestVersion())})}},_setRouteOnSidebarOpen:function(o){if("annotations"===o){var n=this._mediaViewer.getCurrentFile();var m=n.get("annotations").getCurrent();m&&this._setRoute(n,m)}},_setRouteOnSidebarClose:function(m){if("annotations"===m){this._setRoute(this._mediaViewer.getCurrentFile(),null,true)}}});return h});}catch(e){WRMCB(e)};;try{define("cp/component/permalink/permalink-plugin",["cp/component/permalink/file-router"],function(c){var a;var b=function(d){if(!d.getConfig().enablePermalinks){return}a=new c({mediaViewer:d})};b.setRoutingEnabled=function(d){if(a){a.setEnabled(d)}};b.startRouting=function(){a.start()};b.setRouteForPin=function(e,d){if(a){a._setRoute(e,d)}};return b});(function(){var a=require("cp/component/permalink/permalink-plugin");var b=require("MediaViewer");b.registerPlugin("permalink",a)})();}catch(e){WRMCB(e)};